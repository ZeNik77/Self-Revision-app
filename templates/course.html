{% extends "base.html" %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
{% endblock %}

{% block content %}
<div class="d-flex">

  <!-- Side-Bar -->
  <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary absolute" style="width: 240px; height: 100%;">
    <div class="list-group list-group-flush border-bottom scrollarea">

      {% for t in topics %}
      <a href="{% url 'topic' course.course_id t.topic_id %}" class="list-group-item list-group-item-action py-3 lh-sm" aria-current="true">
        <div class="d-flex w-100 align-items-center justify-content-between">
          <strong class="mb-1">{{ t.name }}</strong>
        </div>
      </a> 
      {% endfor %}

      <a href="{% url 'course' course.course_id %}" class="list-group-item list-group-item-action py-3 lh-sm" aria-current="true">
        <div class="d-flex w-100 align-items-center justify-content-between">
          <strong class="mb-1">Создать тему</strong>
        </div>
      </a> 
      <!--
      <a href="./topics/curved_integrals" class="list-group-item list-group-item-action py-3 lh-sm" aria-current="true">
        <div class="d-flex w-100 align-items-center justify-content-between">
          <strong class="mb-1">Криволинейные интегралы</strong>
        </div>
      </a> 
      -->
    </div>
  </div>
  {% if topic %}
  <div class="col-md-6 mx-auto mb-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ topic.name }}</h5>
        <span class="badge bg-light text-dark">{{ course.name }}</span>
      </div>
      <div class="card-body">
        <p class="card-text">
          {{ topic.description }}
        </p>
        <form id="generateTestForm">
          {{ addTestForm.course_id }}
          {{ addTestForm.topic_id }}
          <div class="mb-3">
            <button type="submit" id="submitTest" class="btn btn-success">Generate test on the topic</button>
          </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="container mt-5">
    <form id="addTopicForm" class="card shadow-sm p-4" method="POST">
      {% csrf_token %}
      <h4 class="mb-3 text-primary">Add topic</h4>

      <div class="mb-3">
        {{ addTopicForm.non_field_errors }}
        {{ addTopicForm.topic_name.label }}
        {{ addTopicForm.topic_name }}
        {{ addTopicForm.topic_description.label }}
        {{ addTopicForm.topic_description }}
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button type="submit" name="add_topic" id="add_topic" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>
  {% endif %}
  <div class="container mt-5">
    <form id="aiForm" class="card shadow-sm p-4">
      {% csrf_token %}
      <h4 class="mb-3 text-primary">Talk to AI</h4>

      <div class="mb-3">
        {{ form.non_field_errors }}
        {{ form.prompt.label_tag }}
        {{ form.prompt }}
        <div class="form-check form-switch mb-3">
          {{ form.internet_toggle }}
          <label class="form-check-label" for="{{ form.toggle.id_for_label }}">
            {{ form.internet_toggle.label }}
          </label>
        </div>
        {{ form.file.label_tag }}
        {{ form.file }}
        {{ form.course }}
        {{ form.course_id }}
        {{ form.topic_name }}
        {{ form.topic_description }}
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button type="submit" id="submitBtn" class="btn btn-success">Submit</button>
        <span id="loadingText" class="text-muted d-none">
          ⏳ Generating...
        </span>
      </div>

      <div id="aiAnswerBox" class="d-none">
        <label class="form-label fw-bold">AI Response</label>
        <div id="aiAnswer" class="p-3 bg-light border rounded">ХУИ
        </div>
      </div>
    </form>
  </div>
</div>

<script>
    $(document).ready(function() {
        $('#aiForm').on('submit', function(event) {
            event.preventDefault();
            $('#courseText').val('{{ course.name }}')
            $('#topic_nameText').val('{{ topic.name }}')
            $('#course_idText').val('{{ course.course_id }}')
            $('#topic_descriptionText').val('{{ topic.description }}')
            formData = new FormData(this);
            $('#loadingText').removeClass('d-none');
            $.ajax({
                url: '{% url "sendMessage" %}',
                type: 'POST',
                contentType: false,
                processData: false,
                data: formData,
                success: function(response) {
                    $('#loadingText').addClass('d-none');
                    $('#aiAnswerBox').removeClass('d-none');
                    $('#fileInput').val('');   
                    $('#aiAnswer').text(response.message);
                }
            });
        });
    });
</script>
{% endblock %}