{% extends "base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-4rem)]">
    <!-- sidebar -->
    <aside class="w-64 bg-white border-r overflow-y-auto p-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Your Course</h2>
            <button id="openSubtopicModal" class="text-sm text-indigo-600 hover:underline">+ Add</button>
        </div>

        <div id="subtopicList" class="space-y-2">
            {% for sub in subtopics %}
                <div class="px-3 py-2 rounded hover:bg-gray-100 bg-gray-50">
                    {{ sub.name }}
                </div>
            {% empty %}
                <p class="text-gray-400 text-sm">No subtopics yet</p>
            {% endfor %}
        </div>
    </aside>

    <!-- main content -->
    <div class="flex-1 p-6 overflow-y-auto">
        <h1 class="text-2xl font-bold mb-4">{{ course.name }}</h1>
        <p class="mb-6 text-gray-600">{{ course.description }}</p>

        <label for="editor" class="block text-sm font-medium text-gray-700 mb-1">Course content:</label>
        <textarea id="editor" rows="12"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring focus:ring-indigo-200">
            {{ course.content }}
        </textarea>
    </div>
</div>

<!-- where we add subtopic -->
<div id="subtopicModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
        <h3 class="text-lg font-semibold mb-4">Add Subtopic</h3>
        <form method="POST">
            {% csrf_token %}
            <input type="text" name="subtopic_name" placeholder="Subtopic name"
                   class="w-full mb-4 px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200" required>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelModal" class="px-4 py-2 text-sm text-gray-600">Cancel</button>
                <button type="submit" name="add_subtopic"
                        class="px-4 py-2 text-sm text-white bg-indigo-600 rounded hover:bg-indigo-700">
                    Add
                </button>
            </div>
        </form>
    </div>
</div>

<!-- floating AI Button -->
<button id="openAIPopup"
    class="fixed bottom-6 right-6 z-50 px-4 h-14 rounded-full bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 focus:outline-none flex items-center justify-center text-sm font-medium">
    AI Help
</button>

<!-- AI Help Popup -->
<div id="aiPopup" class="fixed bottom-24 right-6 z-50 w-80 max-h-[90vh] overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden flex-col gap-3 transition-all duration-300">
    <h3 class="text-lg font-semibold mb-2">Ask AI</h3>

    <!-- Normal Mode -->
    <div id="aiMain" class="flex flex-col gap-3">
        <textarea id="aiQuestion" rows="3" placeholder="Ask your question..."
            class="w-full p-2 border rounded-md focus:outline-none focus:ring focus:ring-indigo-200 text-sm resize-none"></textarea>

        <div class="flex justify-between items-center">
            <div class="space-x-2">
                <button id="generateTestBtn" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">Test</button>
                <button id="reviseBtn" class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">Revise</button>
            </div>
            <button id="sendQuestion" class="w-9 h-9 rounded-full bg-indigo-500 hover:bg-indigo-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M5 12h14M12 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Test Setup -->
    <div id="testSetup" class="hidden flex flex-col gap-3">
        <label class="text-sm font-medium">What to test?</label>
        <select id="testTarget" class="w-full border rounded p-2 text-sm">
            <option value="course">Whole Course</option>
            {% for sub in subtopics %}
            <option value="sub_{{ sub.id }}">{{ sub.name }}</option>
            {% endfor %}
        </select>
        <button id="startTest" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">Start Test</button>
    </div>

    <!-- Test Questions -->
    <div id="testContainer" class="hidden">
        <!-- Filled dynamically -->
    </div>
</div>

<script>
    document.getElementById("openSubtopicModal").onclick = () => {
        document.getElementById("subtopicModal").classList.remove("hidden");
        document.getElementById("subtopicModal").classList.add("flex");
    };
    document.getElementById("cancelModal").onclick = () => {
        document.getElementById("subtopicModal").classList.add("hidden");
    };

    const aiPopup = document.getElementById("aiPopup");
    const aiMain = document.getElementById("aiMain");
    const testSetup = document.getElementById("testSetup");
    const testContainer = document.getElementById("testContainer");

    document.getElementById("openAIPopup").onclick = () => {
        aiPopup.classList.toggle("hidden");
    };

    // нужно заменить на API
    let questions = [];
    let currentQuestionIndex = 0;
    let answers = [];

    document.getElementById("generateTestBtn").onclick = () => {
        aiMain.classList.add("hidden");
        testSetup.classList.remove("hidden");
    };

    document.getElementById("startTest").onclick = () => {
    // примеры вопросов просто
    questions = [
        { q: "What is Python?", options: ["A snake", "A programming language", "A dance move"], correct: 1 },
        { q: "What is Django?", options: ["A movie", "A framework", "A drink"], correct: 1 }
    ];
        answers = new Array(questions.length).fill(null);
        currentQuestionIndex = 0;

        testSetup.classList.add("hidden");
        testContainer.classList.remove("hidden");
        renderQuestion();
    };

    function renderQuestion() {
        const q = questions[currentQuestionIndex];
        testContainer.innerHTML = `
            <div class="space-y-3">
                <div class="text-sm font-medium">Question ${currentQuestionIndex + 1} of ${questions.length}</div>
                <div class="text-base font-semibold">${q.q}</div>
                ${q.options.map((opt, i) => `
                    <label class="block">
                        <input type="radio" name="option" value="${i}" class="mr-2" ${answers[currentQuestionIndex] === i ? 'checked' : ''}>
                        ${opt}
                    </label>
                `).join('')}
                <div class="flex justify-between mt-4">
                    <button ${currentQuestionIndex === 0 ? 'disabled' : ''} onclick="prevQuestion()" class="text-sm text-gray-500 hover:underline">Back</button>
                    <button onclick="nextQuestion()" class="text-sm text-indigo-600 hover:underline">${currentQuestionIndex === questions.length - 1 ? 'Finish' : 'Next'}</button>
                </div>
            </div>
        `;
    }

    function prevQuestion() {
        currentQuestionIndex--;
        renderQuestion();
    }

function nextQuestion() {
        const selected = document.querySelector('input[name="option"]:checked');
        if (selected) {
            answers[currentQuestionIndex] = parseInt(selected.value);
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                showResults();
            }
        } else {
            alert("Please select an answer.");
        }
    }

    function showResults() {
        let correct = 0;
        testContainer.innerHTML = `<div class="mb-4 text-lg font-bold">Test Results</div>`;
        questions.forEach((q, i) => {
            const isCorrect = answers[i] === q.correct;
            if (isCorrect) correct++;
            testContainer.innerHTML += `
                <div class="mb-2">
                    <div class="font-semibold">${i + 1}. ${q.q}</div>
                    <div class="${isCorrect ? 'text-green-600' : 'text-red-600'} text-sm">
                        Your answer: ${q.options[answers[i]] || '—'} ${isCorrect ? '✔️' : `✖️ (Correct: ${q.options[q.correct]})`}
                    </div>
                </div>
            `;
        });
        testContainer.innerHTML += `
            <div class="mt-4 font-semibold">
                Score: ${correct} / ${questions.length}
            </div>
            <button onclick="restartAI()" class="mt-4 text-sm text-indigo-600 hover:underline">Back to Assistant</button>
        `;
    }

    function restartAI() {
        testContainer.classList.add("hidden");
        aiMain.classList.remove("hidden");
    }
</script>
{% endblock %}